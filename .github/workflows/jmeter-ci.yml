# yaml
name: JMeter CI

on:
  push:
    paths:
      - 'tests/**'
  pull_request:
    paths:
      - 'tests/**'

jobs:
  jmeter:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java (required for JMeter)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'

      - name: Download and prepare JMeter
        run: |
          JMETER_VERSION=5.6.3
          wget -q https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-${JMETER_VERSION}.tgz
          tar -xzf apache-jmeter-${JMETER_VERSION}.tgz
          echo "$PWD/apache-jmeter-${JMETER_VERSION}/bin" >> $GITHUB_PATH

      - name: Run JMeter test (non-GUI)
        run: |
          mkdir -p results
          # Override properties:
          # -Jtarget_host  : target host (default example.com)
          # -Jtarget_path  : path on host (default /)
          # -Jthreads      : number of threads (default 5)
          # -Jrampup       : ramp-up in seconds (default 5)
          JMETER_HOME=$(ls -d apache-jmeter-*)
          ${JMETER_HOME}/bin/jmeter -n -t tests/sample_test.jmx \
            -l results/results.jtl \
            -Jtarget_host=${{ github.event.inputs.target_host || 'example.com' }} \
            -Jtarget_path=${{ github.event.inputs.target_path || '/' }} \
            -Jthreads=5 -Jrampup=5 || true

      - name: Generate HTML report (best-effort)
        run: |
          mkdir -p results/html_report
          JMETER_HOME=$(ls -d apache-jmeter-*)
          ${JMETER_HOME}/bin/jmeter -g results/results.jtl -o results/html_report || true

      - name: Upload results and report
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-results
          path: results
